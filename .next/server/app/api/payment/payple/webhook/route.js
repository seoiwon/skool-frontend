(()=>{var e={};e.id=176,e.ids=[176],e.modules={3931:e=>{function webpackEmptyContext(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}webpackEmptyContext.keys=()=>[],webpackEmptyContext.resolve=webpackEmptyContext,webpackEmptyContext.id=3931,e.exports=webpackEmptyContext},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{"use strict";e.exports=require("buffer")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},7310:e=>{"use strict";e.exports=require("url")},9796:e=>{"use strict";e.exports=require("zlib")},3683:()=>{},4041:()=>{},7227:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>d,originalPathname:()=>m,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>l,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>_});var s={};r.r(s),r.d(s,{POST:()=>POST});var o=r(6963),a=r(5533),n=r(5999),i=r(9988);async function POST(e){try{if(!i.O)return n.Z.json({error:"Database not configured"},{status:500});let t=await e.json();if(console.log("Payple 웹훅 데이터:",t),"success"===t.PCD_PAY_RST)return await handlePaymentSuccess(t),n.Z.json({success:!0,message:"웹훅 처리 완료"});if("cancel"===t.PCD_PAY_RST||"error"===t.PCD_PAY_RST)return await handlePaymentFailure(t),n.Z.json({success:!0,message:"웹훅 처리 완료"});if("refund"===t.PCD_PAY_RST)return await handleRefund(t),n.Z.json({success:!0,message:"환불 웹훅 처리 완료"});return n.Z.json({success:!0,message:"알 수 없는 웹훅 타입"})}catch(e){return console.error("웹훅 처리 오류:",e),n.Z.json({success:!1,message:"웹훅 처리 중 오류가 발생했습니다."},{status:500})}}async function handlePaymentSuccess(e){try{let t=e.PCD_PAY_OID.split("_"),r=t[1],s=t[2],{data:o,error:a}=await i.O.from("payments").upsert({id:e.PCD_PAY_OID,user_id:s,course_id:r,amount:parseInt(e.PCD_PAY_TOTAL),payment_method:"card",payment_status:"completed",transaction_id:e.PCD_PAY_NO,payment_data:e,updated_at:new Date().toISOString()}).select().single();if(a)throw console.error("결제 정보 저장 실패:",a),a;let{error:n}=await i.O.from("course_enrollments").upsert({user_id:s,course_id:r,payment_id:o.id,enrolled_at:new Date().toISOString()},{onConflict:"user_id,course_id"});if(n)throw console.error("수강 등록 실패:",n),n;let{error:c}=await i.O.rpc("increment_course_students",{course_id:r});c&&console.error("수강생 수 업데이트 실패:",c),console.log("결제 및 수강 등록 완료:",o.id)}catch(e){throw console.error("결제 성공 처리 오류:",e),e}}async function handlePaymentFailure(e){try{let{error:t}=await i.O.from("payments").upsert({id:e.PCD_PAY_OID,payment_status:"cancel"===e.PCD_PAY_RST?"cancelled":"failed",payment_data:e,updated_at:new Date().toISOString()});if(t)throw console.error("결제 실패 정보 저장 실패:",t),t;console.log("결제 실패/취소 처리 완료:",e.PCD_PAY_OID)}catch(e){throw console.error("결제 실패 처리 오류:",e),e}}async function handleRefund(e){try{let t=e.PCD_PAY_OID.split("_"),r=t[1],s=t[2],{error:o}=await i.O.from("payments").update({payment_status:"refunded",payment_data:e,updated_at:new Date().toISOString()}).eq("id",e.PCD_PAY_OID);if(o)throw console.error("환불 정보 업데이트 실패:",o),o;let{error:a}=await i.O.from("course_enrollments").delete().eq("user_id",s).eq("course_id",r);if(a)throw console.error("수강 등록 취소 실패:",a),a;let{error:n}=await i.O.rpc("decrement_course_students",{course_id:r});n&&console.error("수강생 수 감소 실패:",n),console.log("환불 처리 완료:",e.PCD_PAY_OID)}catch(e){throw console.error("환불 처리 오류:",e),e}}let c=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payment/payple/webhook/route",pathname:"/api/payment/payple/webhook",filename:"route",bundlePath:"app/api/payment/payple/webhook/route"},resolvedPagePath:"/home/mustard-3/Documents/code/skool/frontend/app/api/payment/payple/webhook/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:l,headerHooks:d,staticGenerationBailout:_}=c,m="/api/payment/payple/webhook/route"},9988:(e,t,r)=>{"use strict";r.d(t,{O:()=>n});var s=r(3630);let o="https://pgtsxojnziyfkgghzmib.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBndHN4b2pueml5ZmtnZ2h6bWliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MDEwMjMsImV4cCI6MjA2NTk3NzAyM30.BP9rHr3lfNhMCYPLulyj3ia2z8Q9sbsc1xqS1mjVJ8g",n=o&&a?(0,s.eI)(o,a):null}};var t=require("../../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[546,508],()=>__webpack_exec__(7227));module.exports=r})();